<script>
async function openProxyTab(url, customTitle = "Proxy Viewer", faviconUrl = "") {
  if (!url) return alert("Please enter a URL.");
  if (!/^https?:\/\//i.test(url)) url = "https://" + url;

  const newWindow = window.open("about:blank", "_blank");
  if (!newWindow) return alert("Popup blocked. Please allow popups.");

  let faviconTag = faviconUrl ? `<link rel="icon" href="${faviconUrl}">` : "";

  newWindow.document.open();
  newWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>${customTitle}</title>
      ${faviconTag}
      <style>
        body, html { margin:0; padding:0; height:100%; background:black; color:white; display:flex; flex-direction:column; }
        #loading { text-align:center; padding:20px; font-size:20px; }
        iframe { border:0; flex:1; width:100%; height:100%; display:none; }
      </style>
    </head>
    <body>
      <div id="loading">Loading ${url}...</div>
      <iframe id="proxyFrame" src="${url}"></iframe>

      <script>
        const iframe = document.getElementById('proxyFrame');
        const loading = document.getElementById('loading');

        // Show iframe when fully loaded
        iframe.onload = () => {
          loading.style.display = 'none';
          iframe.style.display = 'block';
        };

        // Intercept clicks inside iframe (works only for same-origin)
        iframe.addEventListener('load', () => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.addEventListener('click', e => {
              const a = e.target.closest('a');
              if (a && a.href) {
                e.preventDefault();
                iframe.src = a.href; // Only works if same-origin
                loading.style.display = 'block';
                iframe.style.display = 'none';
              }
            });
          } catch(err) {
            // Cross-origin links cannot be intercepted
            console.warn("Cannot intercept links: cross-origin policy", err);
          }
        });
      </script>
    </body>
    </html>
  `);
  newWindow.document.close();
}

// Button functions
function openInNewTab() {
  const url = document.getElementById('urlInput').value.trim();
  const title = document.getElementById('titleInput').value.trim() || "Proxy Viewer";
  const favicon = document.getElementById('faviconInput').value.trim();
  openProxyTab(url, title, favicon);
}

function openGitHubSite() {
  const url = document.getElementById('ghInput').value.trim();
  openProxyTab(url, "GitHub Proxy", "");
}

// Enter key = quick open
document.getElementById('urlInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') openInNewTab();
});
</script>
